name: Soroban CI

# Trigger on every push and PR to ensure we catch the workflow
on: [push, pull_request]

jobs:
  build_and_test:
    name: Test and Build All Contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.81.0
          targets: wasm32-unknown-unknown
          components: rustfmt, clippy

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Run All Tests
        # This will run the 11 tests you just showed me
        run: cargo test --all-features

      - name: Install Stellar CLI
        run: cargo install --locked stellar-cli --features opt

      - name: Build All Contracts
        # In a workspace, this builds all members (lp manager and lp contract)
        run: stellar contract build

      - name: Optimize and Size Check
        run: |
          # Find all built WASMs and optimize them
          find target/wasm32-unknown-unknown/release/ -name "*.wasm" ! -name "*.optimized.wasm" -exec stellar contract optimize --wasm {} \;

          # Display sizes and fail if any exceed 64KB
          echo "--- WASM Size Report ---"
          for optimized in $(find target/wasm32-unknown-unknown/release/ -name "*.optimized.wasm"); do
            SIZE=$(stat -c%s "$optimized")
            echo "File: $(basename $optimized) | Size: $SIZE bytes"
            if [ "$SIZE" -gt 65536 ]; then
              echo "ERROR: $optimized is too large for the network!"
              exit 1
            fi
          done

      - name: Archive Optimized WASMs
        uses: actions/upload-artifact@v4
        with:
          name: optimized-contracts
          path: target/wasm32-unknown-unknown/release/*.optimized.wasm
