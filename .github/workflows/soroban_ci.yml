name: Soroban CI

on:
  push:
    branches: ["main", "development", "new_impl"]
  pull_request:
    branches: ["main"]

jobs:
  test_and_build:
    name: ${{ matrix.contract_path }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Update these paths to match your folder names exactly
        contract_path:
          - "contracts/liquidity_manager_contract"
          - "contracts/liquidity_provider_contract"

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.81.0
          components: rustfmt, clippy
          targets: wasm32-unknown-unknown

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          # This ensures the cache is separated by contract
          workspaces: ${{ matrix.contract_path }}

      - name: Format Check
        run: cargo fmt --all -- --check
        working-directory: ${{ matrix.contract_path }}

      - name: Run Tests
        run: cargo test --all-features
        working-directory: ${{ matrix.contract_path }}

      - name: Install Stellar CLI
        run: cargo install --locked stellar-cli --features opt

      - name: Build Contract
        run: stellar contract build
        working-directory: ${{ matrix.contract_path }}

      - name: Optimize & Size Check
        working-directory: ${{ matrix.contract_path }}
        run: |
          stellar contract optimize --wasm target/wasm32-unknown-unknown/release/*.wasm

          # Check if size is under 64KB
          for optimized in target/wasm32-unknown-unknown/release/*.optimized.wasm; do
            SIZE=$(stat -c%s "$optimized")
            echo "File: $optimized Size: $SIZE bytes"
            if [ "$SIZE" -gt 65536 ]; then
              echo "Error: WASM exceeds 64KB limit"
              exit 1
            fi
          done

      - name: Upload Optimized WASM
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.contract_path }}-optimized
          path: ${{ matrix.contract_path }}/target/wasm32-unknown-unknown/release/*.optimized.wasm
